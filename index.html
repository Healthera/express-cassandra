<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Express Cassandra by masumsoft</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Express Cassandra</h1>
      <h2 class="project-tagline">Framework Independent Cassandra Object Models (ORM) for NodeJS</h2>
      <a href="https://github.com/masumsoft/express-cassandra" class="btn">View on GitHub</a>
      <a href="https://github.com/masumsoft/express-cassandra/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/masumsoft/express-cassandra/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p><a href="https://travis-ci.org/masumsoft/express-cassandra"><img src="https://travis-ci.org/masumsoft/express-cassandra.svg" alt="Build Status"></a>
<a href="https://www.npmjs.com/package/express-cassandra"><img src="https://img.shields.io/npm/dm/express-cassandra.svg" alt="Download Stats"></a>
<a href="https://www.npmjs.com/package/express-cassandra"><img src="https://badge.fury.io/js/express-cassandra.svg" alt="Npm Version"></a></p>

<h1>
<a id="express-cassandra" class="anchor" href="#express-cassandra" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>express-cassandra</h1>

<p>No more hassling with raw cql queries from your nodejs web frameworks. express-cassandra automatically loads your models and provides you with object oriented mapping to your cassandra tables like a standard ORM.</p>

<p>This module uses datastax <a href="https://github.com/datastax/nodejs-driver">cassandra-driver</a> for node and many of the orm features are wrapper over a largely modified version of <a href="https://github.com/3logic/apollo-cassandra">apollo-cassandra</a> module. The modifications made to the orm library was necessary to support missing features in the orm, keep it updated with the latest cassandra releases and to make it compatible with requirements of this module.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<p>For cassandra version 3.x</p>

<pre><code>npm install express-cassandra
</code></pre>

<p>For older cassandra 2.x</p>

<pre><code>npm install express-cassandra@0.5.4
</code></pre>

<p>Please note that if you use the legacy cassandra 2.x compliant version then please use the corresponding README.md file for that version. The following documentation is for version 3.x only. The materialized view support and several other part of the documentation is strictly applicable for cassandra 3.x and will not work in earlier versions of cassandra.</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> models <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express-cassandra<span class="pl-pds">'</span></span>);

<span class="pl-c">//Tell express-cassandra to use the models-directory, and</span>
<span class="pl-c">//use bind() to load the models using cassandra configurations.</span>

<span class="pl-c">//If your keyspace doesn't exist it will be created automatically</span>
<span class="pl-c">//using the default replication strategy provided here.</span>

<span class="pl-c">//If dropTableOnSchemaChange=true, then if your model schema changes,</span>
<span class="pl-c">//the corresponding cassandra table will be dropped and recreated with</span>
<span class="pl-c">//the new schema. Setting this to false will send an error message</span>
<span class="pl-c">//in callback instead for any model attribute changes.</span>
<span class="pl-c">//</span>
<span class="pl-c">//If createKeyspace=false, then it won't be checked whether the</span>
<span class="pl-c">//specified keyspace exists and, if not, it won't get created</span>
<span class="pl-c">// automatically.</span>
<span class="pl-smi">models</span>.<span class="pl-en">setDirectory</span>( <span class="pl-c1">__dirname</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>/models<span class="pl-pds">'</span></span>).<span class="pl-en">bind</span>(
    {
        clientOptions<span class="pl-k">:</span> {
            contactPoints<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>],
            protocolOptions<span class="pl-k">:</span> { port<span class="pl-k">:</span> <span class="pl-c1">9042</span> },
            keyspace<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mykeyspace<span class="pl-pds">'</span></span>,
            queryOptions<span class="pl-k">:</span> {consistency<span class="pl-k">:</span> <span class="pl-smi">models</span>.<span class="pl-smi">consistencies</span>.<span class="pl-smi">one</span>}
        },
        ormOptions<span class="pl-k">:</span> {
            defaultReplicationStrategy <span class="pl-k">:</span> {
                class<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>SimpleStrategy<span class="pl-pds">'</span></span>,
                replication_factor<span class="pl-k">:</span> <span class="pl-c1">1</span>
            },
            dropTableOnSchemaChange<span class="pl-k">:</span> <span class="pl-c1">false</span>, <span class="pl-c">//recommended to keep it false in production, use true for development convenience.</span>
            createKeyspace<span class="pl-k">:</span> <span class="pl-c1">true</span>
        }
    },
    <span class="pl-k">function</span>(<span class="pl-smi">err</span>) {
        <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">err</span>.<span class="pl-smi">message</span>);
        <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">models</span>.<span class="pl-en">timeuuid</span>());
    }
);
</pre></div>

<p>Alternatively if you don't want to load your models automatically from a specific directory and want to define and load models yourself, then you can asynchronously load your schemas like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> Cassandra <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express-cassandra<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> cassandra <span class="pl-k">=</span> <span class="pl-smi">Cassandra</span>.<span class="pl-en">createClient</span>({
    clientOptions<span class="pl-k">:</span> {
        contactPoints<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>],
        protocolOptions<span class="pl-k">:</span> { port<span class="pl-k">:</span> <span class="pl-c1">9042</span> },
        keyspace<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>mykeyspace<span class="pl-pds">'</span></span>,
        queryOptions<span class="pl-k">:</span> {consistency<span class="pl-k">:</span> <span class="pl-smi">Cassandra</span>.<span class="pl-smi">consistencies</span>.<span class="pl-smi">one</span>}
    },
    ormOptions<span class="pl-k">:</span> {
        defaultReplicationStrategy <span class="pl-k">:</span> {
            class<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>SimpleStrategy<span class="pl-pds">'</span></span>,
            replication_factor<span class="pl-k">:</span> <span class="pl-c1">1</span>
        },
        dropTableOnSchemaChange<span class="pl-k">:</span> <span class="pl-c1">false</span>,
        createKeyspace<span class="pl-k">:</span> <span class="pl-c1">true</span>
    }
});


<span class="pl-k">var</span> UserSchema <span class="pl-k">=</span> <span class="pl-smi">cassandra</span>.<span class="pl-en">loadSchema</span>(<span class="pl-s"><span class="pl-pds">'</span>users<span class="pl-pds">'</span></span>, {
    fields<span class="pl-k">:</span> {
        name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>,
        password<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>
    },
    key<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]
});

<span class="pl-smi">cassandra</span>.<span class="pl-en">connect</span>(<span class="pl-k">function</span> (<span class="pl-smi">err</span>) {
    <span class="pl-k">if</span> (err) {
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">err</span>.<span class="pl-smi">message</span>);
    } <span class="pl-k">else</span> {
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">cassandra</span>.<span class="pl-smi">modelInstance</span>.<span class="pl-smi">users</span>);
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">cassandra</span>.<span class="pl-smi">modelInstance</span>.<span class="pl-smi">users</span> <span class="pl-k">===</span> UserSchema);
    }
});
</pre></div>

<h2>
<a id="write-a-model-named-personmodeljs-inside-models-directory" class="anchor" href="#write-a-model-named-personmodeljs-inside-models-directory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Write a Model named <code>PersonModel.js</code> inside models directory</h2>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    fields<span class="pl-k">:</span>{
        name    <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>,
        surname <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>,
        age     <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>int<span class="pl-pds">"</span></span>
    },
    key<span class="pl-k">:</span>[<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>]
}
</pre></div>

<p>Note that a model class name should contain the word <code>Model</code> in it,
otherwise it won't be treated as a model class.</p>

<h2>
<a id="lets-insert-some-data-into-personmodel" class="anchor" href="#lets-insert-some-data-into-personmodel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Let's insert some data into PersonModel</h2>

<div class="highlight highlight-source-js"><pre>
<span class="pl-k">var</span> john <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">models.instance</span>.<span class="pl-en">Person</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>John<span class="pl-pds">"</span></span>, surname<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Doe<span class="pl-pds">"</span></span>, age<span class="pl-k">:</span> <span class="pl-c1">32</span>});
<span class="pl-smi">john</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
    <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
});
</pre></div>

<h2>
<a id="now-lets-find-it" class="anchor" href="#now-lets-find-it" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Now let's find it</h2>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">findOne</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">john</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;

    <span class="pl-c">//Note that returned variable john here is an instance of your model,</span>
    <span class="pl-c">//so you can also do john.delete(), john.save() type operations on the instance.</span>
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Found <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">john</span>.<span class="pl-c1">name</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> to be <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">john</span>.<span class="pl-smi">age</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> years old!<span class="pl-pds">'</span></span>);
});
</pre></div>

<h2>
<a id="model-schema-in-detail-by-example" class="anchor" href="#model-schema-in-detail-by-example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Model Schema in detail by example</h2>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    fields<span class="pl-k">:</span> {
        id<span class="pl-k">:</span> {
            type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>uuid<span class="pl-pds">"</span></span>,
            <span class="pl-k">default</span><span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>$db_function<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>uuid()<span class="pl-pds">"</span></span>}
        },
        name<span class="pl-k">:</span> { type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>varchar<span class="pl-pds">"</span></span>, <span class="pl-k">default</span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>no name provided<span class="pl-pds">"</span></span>},
        surname<span class="pl-k">:</span> { type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>varchar<span class="pl-pds">"</span></span>, <span class="pl-k">default</span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>no surname provided<span class="pl-pds">"</span></span>},
        complete_name<span class="pl-k">:</span> {
            type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>varchar<span class="pl-pds">"</span></span>,
            <span class="pl-en">default</span><span class="pl-k">:</span> <span class="pl-k">function</span>() {
                <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-c1">name</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-v">this</span>.<span class="pl-smi">surname</span>;
            }
        },
        age<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>int<span class="pl-pds">"</span></span>,
        active<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>boolean<span class="pl-pds">"</span></span>,
        created<span class="pl-k">:</span> {
            type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>timestamp<span class="pl-pds">"</span></span>,
            <span class="pl-k">default</span><span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>$db_function<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>toTimestamp(now())<span class="pl-pds">"</span></span>}
        }
    },
    key <span class="pl-k">:</span> [[<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>],<span class="pl-s"><span class="pl-pds">"</span>created<span class="pl-pds">"</span></span>],
    clustering_order<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>created<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>desc<span class="pl-pds">"</span></span>},
    materialized_views<span class="pl-k">:</span> {
        view_name1<span class="pl-k">:</span> {
            select<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>age<span class="pl-pds">"</span></span>],
            key <span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">"</span>age<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>created<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>],
        },
        view_name2<span class="pl-k">:</span> {
            select<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>age<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>active<span class="pl-pds">"</span></span>],
            key <span class="pl-k">:</span> [[<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>],<span class="pl-s"><span class="pl-pds">"</span>created<span class="pl-pds">"</span></span>],
            clustering_order<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>created<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>desc<span class="pl-pds">"</span></span>}
        }
    },
    indexes<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>],
    custom_index<span class="pl-k">:</span> {
        on<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>age<span class="pl-pds">'</span></span>,
        using<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>path.to.the.IndexClass<span class="pl-pds">'</span></span>,
        options<span class="pl-k">:</span> {
            option1 <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>...<span class="pl-pds">'</span></span>,
            option2<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>...<span class="pl-pds">'</span></span>
        }
    },
    table_name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>my_custom_table_name<span class="pl-pds">"</span></span>
}
</pre></div>

<p>What does the above code means?</p>

<ul>
<li>
<p><code>fields</code> are the columns of your table. For each column name the value can be a string representing the type or an object containing more specific informations. i.e.</p>

<ul>
<li>
<code>"id"     : { "type": "uuid", "default": {"$db_function": "uuid()"} },</code> in this example id type is <code>uuid</code> and the default value is a cassandra function (so it will be executed from the database).</li>
<li>
<code>"name"   : { "type": "varchar", "default": "no name provided"},</code> in this case name is a varchar and, if no value will be provided, it will have a default value of <code>no name provided</code>. The same goes for <code>surname</code>.</li>
<li>
<code>complete_name</code> the default values is calculated from others field. When the orm processes your model instances, the <code>complete_name</code> will be the result of the function you defined. In the function <code>this</code> is bound to the current model instance.</li>
<li>
<code>age</code> no default is provided and we could write it just as <code>age: "int"</code>.</li>
<li>
<code>active</code> no default is provided and we could write it just as <code>active: "boolean"</code>.</li>
<li>
<code>created</code>, like uuid(), will be evaluated from cassandra using the <code>now()</code> function.</li>
</ul>
</li>
<li><p><code>key</code>: here is where you define the primary key of your table. As you can imagine, the array defines a <code>compound primary key</code> and the first value of the array is the <code>partition key</code> and the others are the <code>clustering keys</code>. The <code>partition key</code> itself can be an array with multiple fields. When a partition key is an array of multiple fields, it is called a <code>composite</code> partition key.</p></li>
</ul>

<p>The partition key is the key field by which cassandra distributes it's data into multiple machines. So when querying cassandra, in most cases you need to provide the partition key, so cassandra knows which machines or partitions contains the data you are looking for.</p>

<p>The clustering keys are used to keep the data sorted according to the field values of those keys in a partition. So that after getting into a partition, cassandra can find the required data under those partitions very quickly. As the data is sorted according to those keys, cassandra can efficiently seek to find the data it needs.</p>

<p>Understanding the primary key parts is a crucial concept to cassandra data modeling. To get a detailed idea about them, read the cassandra documentation. For your convenience, following are some links to the relevant documentation pages:</p>

<p>Read more about composite keys on the <a href="http://docs.datastax.com/en/cql/3.3/cql/cql_using/useCompositePartitionKeyConcept.html">composite key doc</a></p>

<p>Read more about the compound key here on the <a href="http://docs.datastax.com/en/cql/3.3/cql/cql_using/useCompoundPrimaryKeyConcept.html">compound key documentation</a></p>

<ul>
<li><p><code>clustering_order</code>: here you can define the clustering order of the clustering keys. If order is not defined, default value of ASC (ascending) is used.</p></li>
<li><p><code>materialized_views</code> provides you the ability to define cassandra 3.x materialized views for your model table. You may want to read more about it on the <a href="http://docs.datastax.com/en/cql/3.3/cql/cql_using/useCreateMV.html">materialized view documentation</a>. This is generally suited for querying high cardinality fields. If you need to use select * for the materialized view, you can also use <code>select: ['*']</code>.</p></li>
<li><p><code>indexes</code> are the index of your table. It's always an array of field names. You can read more on the <a href="http://docs.datastax.com/en/cql/3.3/cql/cql_using/usePrimaryIndex.html">index documentation</a>. This is generally suited for querying low cardinality fields, but not as low as boolean fields or fields with very limited number of variants. Very low cardinality fields are not a good separator of large datasets and hence not worthwhile to index.</p></li>
<li><p><code>custom_index</code> provides the ability to define custom indexes with a Cassandra table. The <code>on</code> section should contain the column name on which the index should be built, the <code>using</code> section should contain the custom indexer class path and the <code>options</code> section should contain the passed options for the indexer class if any.</p></li>
<li><p><code>table_name</code> provides the ability to use a different name for the actual table in cassandra. By default the lowercased modelname is used as the table name. But if you want a different table name instead, then you may want to use this optional field to specify the custom name for your cassandra table.</p></li>
</ul>

<p>When you instantiate a model, every field you defined in schema is automatically a property of your instances. So, you can write:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">john</span>.<span class="pl-smi">age</span> <span class="pl-k">=</span> <span class="pl-c1">25</span>;
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">john</span>.<span class="pl-c1">name</span>); <span class="pl-c">//John</span>
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">john</span>.<span class="pl-smi">complete_name</span>); <span class="pl-c">// undefined.</span>
</pre></div>

<p><strong>note</strong>: <code>john.complete_name</code> is undefined in the newly created instance but will be populated when the instance is saved because it has a default value in schema definition</p>

<p>Ok, we are done with John, let's delete it:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">john</span>.<span class="pl-en">delete</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-c">//...</span>
});
</pre></div>

<h3>
<a id="a-few-handy-tools-for-your-model" class="anchor" href="#a-few-handy-tools-for-your-model" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A few handy tools for your model</h3>

<p>Express cassandra exposes some node driver methods for convenience. To generate uuids e.g. in field defaults:</p>

<ul>
<li>  <code>models.uuid()</code>
returns a type 3 (random) uuid, suitable for Cassandra <code>uuid</code> fields, as a string</li>
<li>  <code>models.uuidFromString(str)</code>
returns a type 3 uuid from input string, suitable for Cassandra <code>uuid</code> fields</li>
<li>
<p><code>models.timeuuid() / .maxTimeuuid() / .minTimeuuid()</code>
returns a type 1 (time-based) uuid, suitable for Cassandra <code>timeuuid</code> fields, as a string. From the <a href="https://docs.datastax.com/en/cql/3.3/cql/cql_reference/timeuuid_functions_r.html">Datastax documentation</a>:</p>

<blockquote>
<p>The min/maxTimeuuid example selects all rows where the timeuuid column, t, is strictly later than 2013-01-01 00:05+0000 but strictly earlier than 2013-02-02 10:00+0000. The t &gt;= maxTimeuuid('2013-01-01 00:05+0000') does not select a timeuuid generated exactly at 2013-01-01 00:05+0000 and is essentially equivalent to t &gt; maxTimeuuid('2013-01-01 00:05+0000').</p>

<p>The values returned by minTimeuuid and maxTimeuuid functions are not true UUIDs in that the values do not conform to the Time-Based UUID generation process specified by the RFC 4122. The results of these functions are deterministic, unlike the now function.</p>
</blockquote>
</li>
<li>  <code>models.consistencies</code>
this object contains all the available consistency enums defined by node cassandra driver, so you can for example use models.consistencies.one, models.consistencies.quorum etc.</li>
<li>  <code>models.datatypes</code>
this object contains all the available datatypes defined by node cassandra driver, so you can for example use
models.datatypes.Long to deal with the cassandra bigint or counter field types.</li>
</ul>

<h3>
<a id="cassandra-to-javascript-datatypes" class="anchor" href="#cassandra-to-javascript-datatypes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Cassandra to Javascript Datatypes</h3>

<p>When saving or retrieving the value of a column, the value is typed according to the following table.</p>

<table>
<thead>
<tr>
<th>Cassandra Field Types</th>
<th>Javascript Types</th>
</tr>
</thead>
<tbody>
<tr>
<td>ascii</td>
<td>String</td>
</tr>
<tr>
<td>bigint</td>
<td><a href="https://google.github.io/closure-library/api/class_goog_math_Long.html">models.datatypes.Long</a></td>
</tr>
<tr>
<td>blob</td>
<td><a href="https://nodejs.org/api/buffer.html">Buffer</a></td>
</tr>
<tr>
<td>boolean</td>
<td>Boolean</td>
</tr>
<tr>
<td>counter</td>
<td><a href="https://google.github.io/closure-library/api/class_goog_math_Long.html">models.datatypes.Long</a></td>
</tr>
<tr>
<td>date</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-LocalDate.html">models.datatypes.LocalDate</a></td>
</tr>
<tr>
<td>decimal</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-BigDecimal.html">models.datatypes.BigDecimal</a></td>
</tr>
<tr>
<td>double</td>
<td>Number</td>
</tr>
<tr>
<td>float</td>
<td>Number</td>
</tr>
<tr>
<td>inet</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-InetAddress.html">models.datatypes.InetAddress</a></td>
</tr>
<tr>
<td>int</td>
<td>Number (Integer)</td>
</tr>
<tr>
<td>list</td>
<td>Array</td>
</tr>
<tr>
<td>map</td>
<td>Object</td>
</tr>
<tr>
<td>set</td>
<td>Array</td>
</tr>
<tr>
<td>smallint</td>
<td>Number (Integer)</td>
</tr>
<tr>
<td>text</td>
<td>String</td>
</tr>
<tr>
<td>time</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-LocalTime.html">models.datatypes.LocalTime</a></td>
</tr>
<tr>
<td>timestamp</td>
<td>Date</td>
</tr>
<tr>
<td>timeuuid</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-TimeUuid.html">models.datatypes.TimeUuid</a></td>
</tr>
<tr>
<td>tinyint</td>
<td>Number (Integer)</td>
</tr>
<tr>
<td>tuple</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-Tuple.html">models.datatypes.Tuple</a></td>
</tr>
<tr>
<td>uuid</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-Uuid.html">models.datatypes.Uuid</a></td>
</tr>
<tr>
<td>varchar</td>
<td>String</td>
</tr>
<tr>
<td>varint</td>
<td><a href="http://docs.datastax.com/en/drivers/nodejs/3.0/module-types-Integer.html">models.datatypes.Integer</a></td>
</tr>
</tbody>
</table>

<p>For example, you have a User model schema like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    <span class="pl-s"><span class="pl-pds">"</span>fields<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>user_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>bigint<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>user_name<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>
    },
    <span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span> <span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">"</span>user_id<span class="pl-pds">"</span></span>]
}</pre></div>

<p>Now to insert data in the model, you need the Long data type. To create a Long type data, you can use the <code>models.datatypes.Long</code> like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">models.instance</span>.<span class="pl-en">User</span>({
    user_id<span class="pl-k">:</span> <span class="pl-smi">models</span>.<span class="pl-smi">datatypes</span>.<span class="pl-smi">Long</span>.<span class="pl-en">fromString</span>(<span class="pl-s"><span class="pl-pds">'</span>1234556567676782<span class="pl-pds">'</span></span>),
    user_name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>john<span class="pl-pds">'</span></span>
});
<span class="pl-smi">user</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-c">//Now let's find the saved user</span>
    <span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">User</span>.<span class="pl-en">findOne</span>({user_id<span class="pl-k">:</span> <span class="pl-smi">models</span>.<span class="pl-smi">datatypes</span>.<span class="pl-smi">Long</span>.<span class="pl-en">fromString</span>(<span class="pl-s"><span class="pl-pds">'</span>1234556567676782<span class="pl-pds">'</span></span>)}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">john</span>){
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">john</span>.<span class="pl-smi">user_id</span>.<span class="pl-c1">toString</span>()); <span class="pl-c">// john.user_id is of type Long.</span>
    });
});</pre></div>

<h3>
<a id="null-and-unset-values" class="anchor" href="#null-and-unset-values" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Null and unset values</h3>

<p>To complete a distributed DELETE operation, Cassandra replaces it with a special value called a tombstone which can be propagated to replicas. When inserting or updating a field, you can set a certain field to null as a way to clear the value of a field, and it is considered a DELETE operation. In some cases, you might insert rows using null for values that are not specified, and even though our intention is to leave the value empty, Cassandra represents it as a tombstone causing unnecessary overhead.</p>

<p>To avoid tombstones, cassandra has the concept of unset for a parameter value. So you can do the following to unset a field value for example:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">User</span>.<span class="pl-en">update</span>({user_id<span class="pl-k">:</span> <span class="pl-smi">models</span>.<span class="pl-smi">datatypes</span>.<span class="pl-smi">Long</span>.<span class="pl-en">fromString</span>(<span class="pl-s"><span class="pl-pds">'</span>1234556567676782<span class="pl-pds">'</span></span>)}, {
    user_name<span class="pl-k">:</span> <span class="pl-smi">models</span>.<span class="pl-smi">datatypes</span>.<span class="pl-smi">unset</span>
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-c">//user name is now unset</span>
})</pre></div>

<h3>
<a id="counter-column-operations" class="anchor" href="#counter-column-operations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Counter Column Operations</h3>

<p>Cassandra counter column increment and decrement operations are supported via the update operation. To increment/decrement a counter, you can use the following types of update operation:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">//Say your model name is StatsModel that has a user_id as the primary key and visit_count as a counter column.</span>

<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Stats</span>.<span class="pl-en">update</span>({user_id<span class="pl-k">:</span><span class="pl-c1">1234</span>}, {visit_count<span class="pl-k">:</span><span class="pl-c1">2</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-c">//visit_count will be incremented by 2</span>
});

<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Stats</span>.<span class="pl-en">update</span>({user_id<span class="pl-k">:</span><span class="pl-c1">1234</span>}, {visit_count<span class="pl-k">:-</span><span class="pl-c1">1</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-c">//visit_count will be decremented by 1</span>
});</pre></div>

<p>Please note that counter columns has special limitations, to know more about the counter column usage, see the <a href="https://docs.datastax.com/en/cql/3.3/cql/cql_using/useCountersConcept.html">cassandra counter docs</a>.</p>

<h3>
<a id="support-for-collection-data-types" class="anchor" href="#support-for-collection-data-types" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support for Collection Data Types</h3>

<p>Cassandra collection data types (<code>map</code>, <code>list</code> &amp; <code>set</code>) are supported in model schema definitions. An additional <code>typeDef</code> attribute is used to define the collection type.</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {

    <span class="pl-s"><span class="pl-pds">"</span>fields<span class="pl-pds">"</span></span><span class="pl-k">:</span> {

        mymap<span class="pl-k">:</span> {
            type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>map<span class="pl-pds">"</span></span>,
            typeDef<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;varchar, text&gt;<span class="pl-pds">"</span></span>
        },
        mylist<span class="pl-k">:</span> {
            type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>list<span class="pl-pds">"</span></span>,
            typeDef<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;varchar&gt;<span class="pl-pds">"</span></span>
        },
        myset<span class="pl-k">:</span> {
            type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>set<span class="pl-pds">"</span></span>,
            typeDef<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;varchar&gt;<span class="pl-pds">"</span></span>
        }

    }

}
</pre></div>

<p>When saving or updating collection types, use an object for a <code>map</code> value and use an array for <code>set</code> or <code>list</code> value like the following:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-k">var</span> person <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">models.instance</span>.<span class="pl-en">Person</span>({

    mymap<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">'</span>key1<span class="pl-pds">'</span></span><span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>val1<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>key2<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>val2<span class="pl-pds">'</span></span>},
    mylist<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>value1<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>value2<span class="pl-pds">'</span></span>],
    myset<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>value1<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>value2<span class="pl-pds">'</span></span>]

});

<span class="pl-smi">person</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){

});
</pre></div>

<p>If you want to add/remove/update existing map, list or set, then you can always find it using the find function,
then change the map, list or set elements in javascript and use the <code>save</code> function on that model instance to save the changes.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">findOne</span>(query, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">person</span>){
    <span class="pl-smi">person</span>.<span class="pl-smi">mymap</span>.<span class="pl-smi">key1</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>val1 new<span class="pl-pds">'</span></span>;
    <span class="pl-k">delete</span> <span class="pl-smi">person</span>.<span class="pl-smi">mymap</span>.<span class="pl-smi">key2</span>;
    <span class="pl-smi">person</span>.<span class="pl-smi">mymap</span>.<span class="pl-smi">key3</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>val3<span class="pl-pds">'</span></span>;
    <span class="pl-smi">person</span>.<span class="pl-smi">mylist</span>.<span class="pl-c1">push</span>(<span class="pl-s"><span class="pl-pds">'</span>value3<span class="pl-pds">'</span></span>);
    <span class="pl-smi">person</span>.<span class="pl-smi">myset</span>.<span class="pl-c1">splice</span>(<span class="pl-c1">0</span>,<span class="pl-c1">1</span>);

    <span class="pl-smi">person</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){

    });
});</pre></div>

<p>But sometimes you may want to add/remove elements into an existing map, list or set in a single call atomically.
So you can use the update function along with the <code>$add</code> and <code>$remove</code> directive to do that.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">update</span>({userID<span class="pl-k">:</span><span class="pl-c1">1234</span>, age<span class="pl-k">:</span><span class="pl-c1">32</span>}, {
    info<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$add<span class="pl-pds">'</span></span><span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>new2<span class="pl-pds">'</span></span><span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>addition2<span class="pl-pds">'</span></span>}},
    phones<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$add<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>12345<span class="pl-pds">'</span></span>]},
    emails<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">'</span>$add<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>e@f.com<span class="pl-pds">'</span></span>]}
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-en">done</span>();
});</pre></div>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">update</span>({userID<span class="pl-k">:</span><span class="pl-c1">1234</span>, age<span class="pl-k">:</span><span class="pl-c1">32</span>}, {
    info<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$remove<span class="pl-pds">'</span></span><span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>new2<span class="pl-pds">'</span></span><span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>}},
    phones<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$remove<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>12345<span class="pl-pds">'</span></span>]},
    emails<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">'</span>$remove<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>e@f.com<span class="pl-pds">'</span></span>]}
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-en">done</span>();
});</pre></div>

<p>Instead of <code>$add</code>, you may also use <code>$append</code>. Both of them will have the same effect. If you want to prepend in a list instead of append, you can use the <code>$prepend</code> directive like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">update</span>({userID<span class="pl-k">:</span><span class="pl-c1">1234</span>, age<span class="pl-k">:</span><span class="pl-c1">32</span>}, {
    phones<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$prepend<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>654532<span class="pl-pds">'</span></span>]}
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){

});</pre></div>

<p>You can also replace a specific item in a map using the <code>$replace</code> directive like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">update</span>({userID<span class="pl-k">:</span><span class="pl-c1">1234</span>, age<span class="pl-k">:</span><span class="pl-c1">32</span>}, {
    info<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$replace<span class="pl-pds">'</span></span><span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>new<span class="pl-pds">'</span></span><span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>replaced value<span class="pl-pds">'</span></span>}}
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){

});</pre></div>

<p>You may also replace a list item using the index. In this case provide a 2 item array where the first item is the index to replace and the second item is the value you want to set for that index.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">update</span>({userID<span class="pl-k">:</span><span class="pl-c1">1234</span>, age<span class="pl-k">:</span><span class="pl-c1">32</span>}, {
    phones<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$replace<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>23456<span class="pl-pds">'</span></span>]} <span class="pl-c">//replace the phone number at index 1 with the value 23456</span>
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){

});</pre></div>

<h3>
<a id="support-for-frozen-collections" class="anchor" href="#support-for-frozen-collections" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support for Frozen Collections</h3>

<p>Frozen collections are useful if you want to use them in the primary key. Frozen collection can only be replaced as a whole, you cannot for example add/remove elements in a frozen collection.</p>

<div class="highlight highlight-source-js"><pre>myfrozenmap<span class="pl-k">:</span> {
    type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>frozen<span class="pl-pds">"</span></span>,
    typeDef<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;map&lt;varchar, text&gt;&gt;<span class="pl-pds">"</span></span>
}</pre></div>

<h3>
<a id="support-for-tuple-data-type" class="anchor" href="#support-for-tuple-data-type" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support for Tuple Data Type</h3>

<p>Cassandra tuple data types can be declared using the <code>frozen</code> type like the following:</p>

<div class="highlight highlight-source-js"><pre>mytuple<span class="pl-k">:</span> {
    type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>frozen<span class="pl-pds">"</span></span>,
    typeDef<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;tuple&lt;int, text, float&gt;&gt;<span class="pl-pds">"</span></span>
}</pre></div>

<p>To insert/update data into a tuple, use the cassandra Tuple datatype like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> person <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">models.instance</span>.<span class="pl-en">Person</span>({
    <span class="pl-c">//...other fields ommitted for clarity</span>
    mytuple<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">models.datatypes</span>.<span class="pl-en">Tuple</span>(<span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">'</span>bar<span class="pl-pds">'</span></span>, <span class="pl-c1">2.1</span>)
});
</pre></div>

<h3>
<a id="support-for-user-defined-types-functions-and-aggregates" class="anchor" href="#support-for-user-defined-types-functions-and-aggregates" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support for User Defined Types, Functions and Aggregates</h3>

<p>User defined types (UDTs), user defined functions (UDFs) and user defined aggregates (UDAs) are supported too. The UDTs, UDFs &amp; UDAs should be defined globally against your keyspace. You can defined them in the configuration object passed to initialize express-cassandra, so that express cassandra could create and sync them against your keyspace. So you may be able to use them in your schema definition and queries. The configuration object should have some more object keys representing the user defined types, functions and aggregates under <code>ormOptions</code> like the following:</p>

<div class="highlight highlight-source-js"><pre>clientOptions<span class="pl-k">:</span> {
    <span class="pl-c">//... client options are ommitted for clarity</span>
},
ormOptions<span class="pl-k">:</span> {
    <span class="pl-c">//... other orm options are ommitted for clarity</span>
    udts<span class="pl-k">:</span> {
        phone<span class="pl-k">:</span> {
            alias<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>,
            phone_number<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>,
            country_code<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>int<span class="pl-pds">'</span></span>
        },
        address<span class="pl-k">:</span> {
            street<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>,
            city<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>,
            state<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>,
            zip<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>int<span class="pl-pds">'</span></span>,
            phones<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>set&lt;frozen&lt;phone&gt;&gt;<span class="pl-pds">'</span></span>
        }
    },
    udfs<span class="pl-k">:</span> {
        fLog<span class="pl-k">:</span> {
            language<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>java<span class="pl-pds">'</span></span>,
            code<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>return Double.valueOf(Math.log(input.doubleValue()));<span class="pl-pds">'</span></span>,
            returnType<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>double<span class="pl-pds">'</span></span>,
            inputs<span class="pl-k">:</span> {
                input<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>double<span class="pl-pds">'</span></span>
            }
        },
        avgState<span class="pl-k">:</span> {
            language<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>java<span class="pl-pds">'</span></span>,
            code<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>if (val !=null) { state.setInt(0, state.getInt(0)+1); state.setLong(1,state.getLong(1)+val.intValue()); } return state;<span class="pl-pds">'</span></span>,
            returnType<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>tuple&lt;int,bigint&gt;<span class="pl-pds">'</span></span>,
            inputs<span class="pl-k">:</span> {
                state<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>tuple&lt;int,bigint&gt;<span class="pl-pds">'</span></span>,
                val<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>int<span class="pl-pds">'</span></span>
            }
        },
        avgFinal<span class="pl-k">:</span> {
            language<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>java<span class="pl-pds">'</span></span>,
            code<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>double r = 0; if (state.getInt(0) == 0) return null; r = state.getLong(1); r/= state.getInt(0); return Double.valueOf(r);<span class="pl-pds">'</span></span>,
            returnType<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>double<span class="pl-pds">'</span></span>,
            inputs<span class="pl-k">:</span> {
                state<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>tuple&lt;int,bigint&gt;<span class="pl-pds">'</span></span>
            }
        }
    },
    udas<span class="pl-k">:</span> {
        average<span class="pl-k">:</span> {
            input_types<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>int<span class="pl-pds">'</span></span>],
            sfunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>avgState<span class="pl-pds">'</span></span>,
            stype<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>tuple&lt;int,bigint&gt;<span class="pl-pds">'</span></span>,
            finalfunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>avgFinal<span class="pl-pds">'</span></span>,
            initcond<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>(0,0)<span class="pl-pds">'</span></span>
        }
    }
}</pre></div>

<p>After configuring them for your keyspace, you could possibly define fields using udts like the following:</p>

<div class="highlight highlight-source-js"><pre>currencies<span class="pl-k">:</span> {
    type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>frozen<span class="pl-pds">'</span></span>,
    typeDef<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;address&gt;<span class="pl-pds">'</span></span>
}</pre></div>

<p>and use the UDFs and UDAs like any other standard functions using the <code>select</code> attribute:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">findOne</span>({<span class="pl-k">...</span>}, {select<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>fLog(points)<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>average(age)<span class="pl-pds">'</span></span>]}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">user</span>){
    <span class="pl-c">//...</span>
});</pre></div>

<h3>
<a id="support-for-shared-static-columns" class="anchor" href="#support-for-shared-static-columns" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support for shared static columns</h3>

<p>In a table that uses clustering columns, non-clustering columns can be declared static in the schema definition like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-s"><span class="pl-pds">"</span>my_shared_data<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>static<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>
}</pre></div>

<p>Note that static columns are only static within a given partition. Static columns also has several restrictions described in the cassandra <a href="https://docs.datastax.com/en/cql/3.3/cql/cql_reference/refStaticCol.html">static column documentation</a>.</p>

<h3>
<a id="support-for-indexed-collections" class="anchor" href="#support-for-indexed-collections" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support for indexed collections</h3>

<p>Collections can be indexed and queried to find a collection containing a particular value. Sets and lists are indexed slightly differently from maps, given the key-value nature of maps.</p>

<p>Sets and lists can index all values found by indexing the collection column. Maps can index a map key, map value, or map entry using the methods shown below. Multiple indexes can be created on the same map column in a table, so that map keys, values, or entries can be queried. In addition, frozen collections can be indexed using FULL to index the full content of a frozen collection.</p>

<p>For defining indexed collections or frozen full indexes, you can define the corresponsing fields in your schema definition indexes like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-s"><span class="pl-pds">"</span>fields<span class="pl-pds">"</span></span><span class="pl-k">:</span> {<span class="pl-k">...</span>},
<span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span><span class="pl-k">:</span> [<span class="pl-k">...</span>],
<span class="pl-s"><span class="pl-pds">"</span>indexes<span class="pl-pds">"</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">"</span>my_list<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>my_set<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>keys(my_map)<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>entries(my_map)<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>values(my_map)<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>full(my_frozen_field)<span class="pl-pds">"</span></span>],</pre></div>

<p>Now after defining your indexes in your collections, you can use the <code>$contains</code> and <code>$contains_key</code> directives to query those indexes:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">//Find all persons where my_list contains my_value</span>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({my_list<span class="pl-k">:</span> {$contains<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>my_value<span class="pl-pds">'</span></span>}}, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){

});
<span class="pl-c">//Find all persons where my_set contains my_value</span>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({my_set<span class="pl-k">:</span> {$contains<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>my_value<span class="pl-pds">'</span></span>}}, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){

});
<span class="pl-c">//Find all persons where my_map keys contains my_key</span>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({my_map<span class="pl-k">:</span> {$contains_key<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>my_key<span class="pl-pds">'</span></span>}}, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){

});
<span class="pl-c">//Find all persons where my_map contains object {my_key: 'my_value'}</span>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({my_map<span class="pl-k">:</span> {$contains<span class="pl-k">:</span> {my_key<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>my_value<span class="pl-pds">'</span></span>}}}, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){

});
<span class="pl-c">//Find all persons where my_map contains my_value</span>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({my_map<span class="pl-k">:</span> {$contains<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>my_value<span class="pl-pds">'</span></span>}}, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){

});</pre></div>

<p>Now for finding using indexed frozen field using <code>full</code> type index, you can directly use the value of the complex object in your query.</p>

<p>For example your person schema has a frozen map <code>myFrozenMap</code> with typeDef <code>&lt;map &lt;int, text&gt;&gt;</code> that is indexed using the <code>full</code> keyword like the following:</p>

<div class="highlight highlight-source-js"><pre>fields<span class="pl-k">:</span> {
    myFrozenMap<span class="pl-k">:</span> {
        type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>frozen<span class="pl-pds">'</span></span>,
        typeDef<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;map &lt;text, text&gt;&gt;<span class="pl-pds">'</span></span>
    }
},
keys<span class="pl-k">:</span> [<span class="pl-k">...</span>],
indexes<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>full(myFrozenMap)<span class="pl-pds">'</span></span>]</pre></div>

<p>So now you may query like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({
    myFrozenMap<span class="pl-k">:</span> {
        my_key<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>my_value<span class="pl-pds">'</span></span>
    }
}, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is a list of persons where myFrozenMap value is {mykey: 'my_value'}</span>
});</pre></div>

<h2>
<a id="virtual-fields" class="anchor" href="#virtual-fields" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Virtual fields</h2>

<p>Your model could have some fields which are not saved on database. You can define them as <code>virtual</code></p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    <span class="pl-s"><span class="pl-pds">"</span>fields<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>     <span class="pl-k">:</span> { <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>uuid<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>default<span class="pl-pds">"</span></span><span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>$db_function<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>uuid()<span class="pl-pds">"</span></span>} },
        <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>   <span class="pl-k">:</span> { <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>varchar<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>default<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>no name provided<span class="pl-pds">"</span></span>},
        <span class="pl-s"><span class="pl-pds">"</span>surname<span class="pl-pds">"</span></span>   <span class="pl-k">:</span> { <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>varchar<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>default<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>no surname provided<span class="pl-pds">"</span></span>},
        <span class="pl-s"><span class="pl-pds">"</span>complete_name<span class="pl-pds">"</span></span> <span class="pl-k">:</span> {
            <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>varchar<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>virtual<span class="pl-pds">"</span></span> <span class="pl-k">:</span> {
                <span class="pl-en">get</span><span class="pl-k">:</span> <span class="pl-k">function</span>(){<span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-c1">name</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> <span class="pl-pds">'</span></span> <span class="pl-k">+</span><span class="pl-v">this</span>.<span class="pl-smi">surname</span>;},
                <span class="pl-en">set</span><span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>){
                    value <span class="pl-k">=</span> <span class="pl-smi">value</span>.<span class="pl-c1">split</span>(<span class="pl-s"><span class="pl-pds">'</span> <span class="pl-pds">'</span></span>);
                    <span class="pl-v">this</span>.<span class="pl-c1">name</span> <span class="pl-k">=</span> value[<span class="pl-c1">0</span>];
                    <span class="pl-v">this</span>.<span class="pl-smi">surname</span> <span class="pl-k">=</span> value[<span class="pl-c1">1</span>];
                }
            }
        }
    }
}
</pre></div>

<p>A virtual field is simply defined adding a <code>virtual</code> key in field description. Virtuals can have a <code>get</code> and a <code>set</code> function, both optional (you should define at least one of them!).
<code>this</code> inside get and set functions is bound to current instance of your model.</p>

<h2>
<a id="validators" class="anchor" href="#validators" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Validators</h2>

<p>Every time you set a property for an instance of your model, an internal type validator checks that the value is valid. If not an error is thrown. But how to add a custom validator? You need to provide your custom validator in the schema definition. For example, if you want to check age to be a number greater than zero:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    <span class="pl-c">//... other properties hidden for clarity</span>
    age<span class="pl-k">:</span> {
        type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>int<span class="pl-pds">"</span></span>,
        <span class="pl-en">rule</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>){ <span class="pl-k">return</span> value <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>; }
    }
}
</pre></div>

<p>your validator must return a boolean. If someone will try to assign <code>john.age = -15;</code> an error will be thrown.
You can also provide a message for validation error in this way</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    <span class="pl-c">//... other properties hidden for clarity</span>
    age<span class="pl-k">:</span> {
        type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>int<span class="pl-pds">"</span></span>,
        rule <span class="pl-k">:</span> {
            <span class="pl-en">validator</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>){ <span class="pl-k">return</span> value <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>; },
            message   <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Age must be greater than 0<span class="pl-pds">'</span></span>
        }
    }
}
</pre></div>

<p>then the error will have your message. Message can also be a function; in that case it must return a string:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    <span class="pl-c">//... other properties hidden for clarity</span>
    age<span class="pl-k">:</span> {
        type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>int<span class="pl-pds">"</span></span>,
        rule <span class="pl-k">:</span> {
            <span class="pl-en">validator</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>){ <span class="pl-k">return</span> value <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>; },
            <span class="pl-en">message</span>   <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>){ <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">'</span>Age must be greater than 0. You provided <span class="pl-pds">'</span></span><span class="pl-k">+</span> value; }
        }
    }
}
</pre></div>

<p>The error message will be <code>Age must be greater than 0. You provided -15</code></p>

<p>Note that default values <em>are</em> validated if defined either by value or as a javascript function. Defaults defined as DB functions, on the other hand, are never validated in the model as they are retrieved <em>after</em> the corresponding data has entered the DB.
If you need to exclude defaults from being checked you can pass an extra flag:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    <span class="pl-c">//... other properties hidden for clarity</span>
    email<span class="pl-k">:</span> {
        type <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>,
        <span class="pl-k">default</span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;enter your email here&gt;<span class="pl-pds">"</span></span>,
        rule <span class="pl-k">:</span> {
            <span class="pl-en">validator</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>){ <span class="pl-c">/* code to check that value matches an email pattern*/</span> },
            ignore_default<span class="pl-k">:</span> <span class="pl-c1">true</span>
        }
    }
}
</pre></div>

<h2>
<a id="querying-your-data" class="anchor" href="#querying-your-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Querying your data</h2>

<p>Ok, now you have a bunch of people on db. How do I retrieve them?</p>

<h3>
<a id="find-results-are-model-instances" class="anchor" href="#find-results-are-model-instances" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (results are model instances)</h3>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-c">//people is an array of model instances containing the persons with name `John`</span>
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Found <span class="pl-pds">'</span></span>, people);
});

<span class="pl-c">//If you specifically expect only a single object after find, you may do this</span>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">findOne</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">john</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-c">//The variable `john` is a model instance containing the person named `John`</span>
    <span class="pl-c">//`john` will be undefined if no person named `John` was found</span>
    <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Found <span class="pl-pds">'</span></span>, <span class="pl-smi">john</span>.<span class="pl-c1">name</span>);
});
</pre></div>

<p>In the above example it will perform the query <code>SELECT * FROM person WHERE name='john'</code> but <code>find()</code> allows you to perform even more complex queries on cassandra.  You should be aware of how to query cassandra. Every error will be reported to you in the <code>err</code> argument, while in <code>people</code> you'll find instances of <code>Person</code>.</p>

<h4>
<a id="find-results-are-raw-objects" class="anchor" href="#find-results-are-raw-objects" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (results are raw objects)</h4>

<p>If you don't want the orm to cast results to instances of your model you can use the <code>raw</code> option as in the following example:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, { raw<span class="pl-k">:</span> <span class="pl-c1">true</span> }, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects</span>
});
</pre></div>

<h4>
<a id="find-a-more-complex-query" class="anchor" href="#find-a-more-complex-query" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (A more complex query)</h4>

<div class="highlight highlight-source-js"><pre>
<span class="pl-k">var</span> query <span class="pl-k">=</span> {
    name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>, <span class="pl-c">// stays for name='john'</span>
    age <span class="pl-k">:</span> { <span class="pl-s"><span class="pl-pds">'</span>$gt<span class="pl-pds">'</span></span><span class="pl-k">:</span><span class="pl-c1">10</span>, <span class="pl-s"><span class="pl-pds">'</span>$lte<span class="pl-pds">'</span></span><span class="pl-k">:</span><span class="pl-c1">20</span> }, <span class="pl-c">// stays for age&gt;10 and age&lt;=20 You can also use $gt, $gte, $lt, $lte, $eq</span>
    surname <span class="pl-k">:</span> { <span class="pl-s"><span class="pl-pds">'</span>$in<span class="pl-pds">'</span></span><span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>Doe<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>Smith<span class="pl-pds">'</span></span>] }, <span class="pl-c">//This is an IN clause</span>
    $orderby<span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$asc<span class="pl-pds">'</span></span> <span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>age<span class="pl-pds">'</span></span>}, <span class="pl-c">//Order results by age in ascending order. Also allowed $desc and complex order like $orderby:{'$asc' : ['k1','k2'] }</span>
    $limit<span class="pl-k">:</span> <span class="pl-c1">10</span> <span class="pl-c">//limit result set</span>
}

<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>(query, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects satisfying the query conditions above</span>
});
</pre></div>

<h4>
<a id="find-results-to-contain-only-selected-columns" class="anchor" href="#find-results-to-contain-only-selected-columns" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (results to contain only selected columns)</h4>

<p>You can also select particular columns using the select key in the options object like the following example:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, { select<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>name as username<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>age<span class="pl-pds">'</span></span>] }, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects with only name and age</span>
});
</pre></div>

<p>Note that if you use the <code>select</code> option, then the results will always be raw plain objects instead of model instances.</p>

<p>Also <strong>Remember</strong> that your select needs to include all the partition key columns defined for your table!</p>

<p>If your model key looks like this:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c1">module</span>.<span class="pl-smi">exports</span> <span class="pl-k">=</span> {
    fields<span class="pl-k">:</span> {
        <span class="pl-c">//fields are not shown for clarity</span>
    },
    key <span class="pl-k">:</span> [[<span class="pl-s"><span class="pl-pds">"</span>columnOne<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>columnTwo<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>columnThree<span class="pl-pds">"</span></span>],<span class="pl-s"><span class="pl-pds">"</span>columnFour<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>ColumnFive<span class="pl-pds">"</span></span>]
}
</pre></div>

<p>Then your <code>select</code>-array has to at least include the partition key columns like this: <code>select: ['columnOne', 'columnTwo', 'columnThree']</code>.</p>

<h4>
<a id="find-using-aggregate-function" class="anchor" href="#find-using-aggregate-function" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (using aggregate function)</h4>

<p>You can also use <code>aggregate functions</code> using the select key in the options object like the following example:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, { select<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>sum(age)<span class="pl-pds">'</span></span>] }, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects with sum of all ages where name is John</span>
});
</pre></div>

<h4>
<a id="find-using-distinct-select" class="anchor" href="#find-using-distinct-select" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (using distinct select)</h4>

<p>Also, <code>DISTINCT</code> selects are possible:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({}, { select<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>age<span class="pl-pds">'</span></span>], distinct<span class="pl-k">:</span> <span class="pl-c1">true</span> }, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is a distinct array of plain objects with only distinct name and ages.</span>
});
</pre></div>

<h4>
<a id="find-querying-a-materialized-view" class="anchor" href="#find-querying-a-materialized-view" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (querying a materialized view)</h4>

<p>And if you have defined <code>materialized views</code> in your schema as described in the schema detail section, then you can query your views by using the similar find/findOne functions. Just add an option with the materialized view name like the following:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, { materialized_view<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>view_name1<span class="pl-pds">'</span></span>, raw<span class="pl-k">:</span> <span class="pl-c1">true</span> }, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects taken from the materialized view</span>
});
</pre></div>

<h4>
<a id="find-with-allow-filtering" class="anchor" href="#find-with-allow-filtering" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (with allow filtering)</h4>

<p>If you want to set allow filtering option, you may do that like this:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>(query, {raw<span class="pl-k">:</span><span class="pl-c1">true</span>, allow_filtering<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects</span>
});
</pre></div>

<h4>
<a id="find-using-index-expression" class="anchor" href="#find-using-index-expression" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (using index expression)</h4>

<p>If you want to use custom index expressions, you may do that like this:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> query <span class="pl-k">=</span> {
    $expr<span class="pl-k">:</span> {
        index<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>YOUR_INDEX_NAME<span class="pl-pds">'</span></span>,
        query<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>YOUR_CUSTOM_EXPR_QUERY<span class="pl-pds">'</span></span>
    }
}

<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>(query, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){

});
</pre></div>

<h4>
<a id="find-fetching-large-result-sets-using-streaming-queries" class="anchor" href="#find-fetching-large-result-sets-using-streaming-queries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (fetching large result sets using streaming queries)</h4>

<p>The stream() method automatically fetches the following pages, yielding the rows as they come through the network and retrieving the following page after the previous rows were read (throttling).</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">stream</span>({Name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, {raw<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">reader</span>){
    <span class="pl-k">var</span> row;
    <span class="pl-k">while</span> (row <span class="pl-k">=</span> <span class="pl-smi">reader</span>.<span class="pl-en">readRow</span>()) {
        <span class="pl-c">//process row</span>
    }
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-c">//emitted when all rows have been retrieved and read</span>
});</pre></div>

<p>With the eachRow() method, you can retrieve the following pages automatically by setting the autoPage flag to true in the query options to request the following pages automatically. Because eachRow() does not handle backpressure, it is only suitable when there is minimum computation per row required and no additional I/O, otherwise it ends up buffering an unbounded amount of rows.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">eachRow</span>({Name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, {autoPage <span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">n</span>, <span class="pl-smi">row</span>){
    <span class="pl-c">// invoked per each row in all the pages</span>
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">result</span>){
    <span class="pl-c">// ...</span>
});</pre></div>

<p>If you want to retrieve the next page of results only when you ask for it (for example, in a web page or after a certain computation or job finished), you can use the eachRow() method in the following way:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">eachRow</span>({Name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, {fetchSize <span class="pl-k">:</span> <span class="pl-c1">100</span>}, <span class="pl-k">function</span>(<span class="pl-smi">n</span>, <span class="pl-smi">row</span>){
    <span class="pl-c">// invoked per each row in all the pages</span>
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">result</span>){
    <span class="pl-c">// called once the page has been retrieved.</span>
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-k">if</span> (<span class="pl-smi">result</span>.<span class="pl-smi">nextPage</span>) {
        <span class="pl-c">// retrieve the following pages</span>
        <span class="pl-c">// the same row handler from above will be used</span>
        <span class="pl-smi">result</span>.<span class="pl-en">nextPage</span>();
    }
});</pre></div>

<p>You can also use the <code>pageState</code> property, a string token made available in the result if there are additional result pages.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">eachRow</span>({Name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, {fetchSize <span class="pl-k">:</span> <span class="pl-c1">100</span>}, <span class="pl-k">function</span>(<span class="pl-smi">n</span>, <span class="pl-smi">row</span>){
    <span class="pl-c">// invoked per each row in all the pages</span>
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">result</span>){
    <span class="pl-c">// called once the page has been retrieved.</span>
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-c">// store the paging state</span>
    pageState <span class="pl-k">=</span> <span class="pl-smi">result</span>.<span class="pl-smi">pageState</span>;
});</pre></div>

<p>In the next request, use the page state to fetch the following rows.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">eachRow</span>({Name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, {fetchSize <span class="pl-k">:</span> <span class="pl-c1">100</span>, pageState <span class="pl-k">:</span> pageState}, <span class="pl-k">function</span>(<span class="pl-smi">n</span>, <span class="pl-smi">row</span>){
    <span class="pl-c">// invoked per each row in all the pages</span>
}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">result</span>){
    <span class="pl-c">// called once the page has been retrieved.</span>
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-c">// store the next paging state.</span>
      pageState <span class="pl-k">=</span> <span class="pl-smi">result</span>.<span class="pl-smi">pageState</span>;
});</pre></div>

<p>Saving the paging state works well when you only let the user move from one page to the next. But it doesn’t allow random jumps (like "go directly to page 10"), because you can't fetch a page unless you have the paging state of the previous one. Such a feature would require offset queries, which are not natively supported by Cassandra.</p>

<p>Note: The page state token can be manipulated to retrieve other results within the same column family, so it is not safe to expose it to the users.</p>

<h4>
<a id="find-token-based-pagination" class="anchor" href="#find-token-based-pagination" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find (token based pagination)</h4>

<p>You can also use the <code>token</code> comparison function while querying a result set using the $token operator. This is specially useful for <a href="https://docs.datastax.com/en/cql/3.3/cql/cql_using/usePaging.html">paging through unordered partitioner results</a>.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">//consider the following situation</span>
<span class="pl-k">var</span> query <span class="pl-k">=</span> {
    $limit<span class="pl-k">:</span><span class="pl-c1">10</span>
};
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>(query, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of first 10 persons</span>

    <span class="pl-c">//Say your PRIMARY_KEY column is `name` and the 10th person has the name 'John'</span>
    <span class="pl-c">//Now to get the next 10 results, you may use the $token operator like the following:</span>
    <span class="pl-k">var</span> query <span class="pl-k">=</span> {
        name<span class="pl-k">:</span>{
            <span class="pl-s"><span class="pl-pds">'</span>$token<span class="pl-pds">'</span></span><span class="pl-k">:</span>{<span class="pl-s"><span class="pl-pds">'</span>$gt<span class="pl-pds">'</span></span><span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}
        },
        $limit<span class="pl-k">:</span><span class="pl-c1">10</span>
    };
    <span class="pl-c">//The above query translates to `Select * from person where token(name) &gt; token('John') limit 10`</span>
    <span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>(query, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
        <span class="pl-c">//people is an array of objects containing the 11th - 20th person</span>
    });
});</pre></div>

<p>If you have a <code>composite partition key</code>, then the token operator should be contained in comma (,) separated partition key field names and the values should be an array containing the values for the partition key fields. Following is an example to demonstrate that:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> query <span class="pl-k">=</span> {
    <span class="pl-s"><span class="pl-pds">'</span>id,name<span class="pl-pds">'</span></span><span class="pl-k">:</span>{
        <span class="pl-s"><span class="pl-pds">'</span>$token<span class="pl-pds">'</span></span><span class="pl-k">:</span>{
            <span class="pl-s"><span class="pl-pds">'</span>$gt<span class="pl-pds">'</span></span><span class="pl-k">:</span>[<span class="pl-c1">1234</span>,<span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>]
        }
    }
};
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>(query, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){

});</pre></div>

<p>Note that all query clauses must be Cassandra compliant. You cannot, for example, use $in operator for a key which is not part of the primary key. Querying in Cassandra is very basic but could be confusing at first. Take a look at this <a href="http://mechanics.flite.com/blog/2013/11/05/breaking-down-the-cql-where-clause/">post</a> and, obvsiouly, at the <a href="https://docs.datastax.com/en/cql/3.3/cql/cql_using/useQueryDataTOC.html">cql query documentation</a></p>

<h2>
<a id="save--update--delete" class="anchor" href="#save--update--delete" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Save / Update / Delete</h2>

<h3>
<a id="save" class="anchor" href="#save" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Save</h3>

<p>The save operation on a model instance will insert a new record with the attribute values mentioned when creating the model object. It will update the record if it already exists in the database. A record is updated or inserted based on the primary key definition. If the primary key values are same as an existing record, then the record will be updated and otherwise it will be inserted as new record.</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-k">var</span> john <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">models.instance</span>.<span class="pl-en">Person</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>, surname<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Doe<span class="pl-pds">'</span></span>, age<span class="pl-k">:</span> <span class="pl-c1">32</span>});
<span class="pl-smi">john</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
    <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
});
</pre></div>

<p>You can use the find query to get an object and modify it and save it like the following:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">findOne</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">john</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
    <span class="pl-k">if</span>(john){
        <span class="pl-smi">john</span>.<span class="pl-smi">age</span> <span class="pl-k">=</span> <span class="pl-c1">30</span>;
        <span class="pl-smi">john</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
            <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
            <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
        });
    }
});
</pre></div>

<p>The save function also takes optional parameters. By default cassandra will update the row if the primary key
already exists. If you want to avoid on duplicate key updates, you may set if_not_exist:true.</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">john</span>.<span class="pl-en">save</span>({if_not_exist<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
    <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
});
</pre></div>

<p>You can also set an expiry ttl for the saved row if you want. In that case the row will be removed by cassandra
automatically after the time to live has expired.</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c">//The row will be removed after 86400 seconds or one day</span>
<span class="pl-smi">john</span>.<span class="pl-en">save</span>({ttl<span class="pl-k">:</span> <span class="pl-c1">86400</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
    <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
});
</pre></div>

<h3>
<a id="update" class="anchor" href="#update" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Update</h3>

<p>Use the update function if your requirements are not satisfied with the <code>save()</code> function or you directly want to update records without reading them from the db. The update function takes the following forms, (options are optional):</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c">/*</span>
<span class="pl-c">UPDATE person</span>
<span class="pl-c">    USING TTL 86400</span>
<span class="pl-c">    SET email='abc@gmail.com'</span>
<span class="pl-c">WHERE username= 'abc'</span>
<span class="pl-c">    IF EXISTS</span>
<span class="pl-c">*/</span>

<span class="pl-k">var</span> query_object <span class="pl-k">=</span> {username<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>abc<span class="pl-pds">'</span></span>};
<span class="pl-k">var</span> update_values_object <span class="pl-k">=</span> {email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>abc@gmail.com<span class="pl-pds">'</span></span>};
<span class="pl-k">var</span> options <span class="pl-k">=</span> {ttl<span class="pl-k">:</span> <span class="pl-c1">86400</span>, if_exists<span class="pl-k">:</span> <span class="pl-c1">true</span>};
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">update</span>(query_object, update_values_object, options, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
    <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
});


<span class="pl-c">/*</span>
<span class="pl-c">UPDATE person</span>
<span class="pl-c">    SET email='abc@gmail.com'</span>
<span class="pl-c">WHERE username= 'abc'</span>
<span class="pl-c">    IF email='typo@gmail.com'</span>
<span class="pl-c">*/</span>
<span class="pl-k">var</span> query_object <span class="pl-k">=</span> {username<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>abc<span class="pl-pds">'</span></span>};
<span class="pl-k">var</span> update_values_object <span class="pl-k">=</span> {email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>abc@gmail.com<span class="pl-pds">'</span></span>};
<span class="pl-k">var</span> options <span class="pl-k">=</span> {conditions<span class="pl-k">:</span> {email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>typo@gmail.com<span class="pl-pds">'</span></span>}};
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">update</span>(query_object, update_values_object, options, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
    <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
});
</pre></div>

<h3>
<a id="delete" class="anchor" href="#delete" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Delete</h3>

<p>The delete function takes the following form:</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-c">//DELETE FROM person WHERE username='abc';</span>
<span class="pl-k">var</span> query_object <span class="pl-k">=</span> {username<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>abc<span class="pl-pds">'</span></span>};
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">delete</span>(query_object, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
    <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Yuppiie!<span class="pl-pds">'</span></span>);
});
</pre></div>

<p>If you have a model instance and you want to delete the instance object, you may do that like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">findOne</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>John<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">john</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;

    <span class="pl-c">//Note that returned variable john here is an instance of your model,</span>
    <span class="pl-c">//so you can do john.delete() like the following</span>
    <span class="pl-smi">john</span>.<span class="pl-en">delete</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
        <span class="pl-c">//...</span>
    });
});</pre></div>

<h2>
<a id="raw-query" class="anchor" href="#raw-query" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Raw Query</h2>

<p>You can get the raw query interface from cassandra nodejs-driver using the <code>execute_query</code> method.</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-k">var</span> query <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Select * from user where gender=? and age &gt; ? limit ?<span class="pl-pds">"</span></span>;
<span class="pl-k">var</span> params <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">'</span>male<span class="pl-pds">'</span></span>, <span class="pl-c1">18</span>, <span class="pl-c1">10</span>];
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">execute_query</span>(query, params, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects</span>
});
</pre></div>

<h2>
<a id="batching-orm-operations" class="anchor" href="#batching-orm-operations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Batching ORM Operations</h2>

<p>You can batch any number of save, update and delete operations using the <code>models.doBatch</code> function. To use more than one of those functions as a combined batch operation, you need to tell each of the save/update/delete functions, that you want to get the final built query from the orm instead of executing it immediately. You can do that by adding a <code>return_query</code> parameter in the options object of the corresponding function and build an array of operations to execute atomically like the following:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> queries <span class="pl-k">=</span> [];

<span class="pl-k">var</span> <span class="pl-c1">event</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">models.instance</span>.<span class="pl-en">Event</span>({
    id<span class="pl-k">:</span> <span class="pl-c1">3</span>,
    body<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>hello3<span class="pl-pds">'</span></span>
});
<span class="pl-k">var</span> save_query <span class="pl-k">=</span> <span class="pl-c1">event</span>.<span class="pl-en">save</span>({return_query<span class="pl-k">:</span> <span class="pl-c1">true</span>});
<span class="pl-smi">queries</span>.<span class="pl-c1">push</span>(save_query);

<span class="pl-k">var</span> update_query <span class="pl-k">=</span> <span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Event</span>.<span class="pl-en">update</span>(
    {id<span class="pl-k">:</span> <span class="pl-c1">1</span>},
    {body<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>hello1 updated<span class="pl-pds">'</span></span>},
    {return_query<span class="pl-k">:</span> <span class="pl-c1">true</span>}
);
<span class="pl-smi">queries</span>.<span class="pl-c1">push</span>(update_query);

<span class="pl-k">var</span> delete_query <span class="pl-k">=</span> <span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Event</span>.<span class="pl-en">delete</span>(
    {id<span class="pl-k">:</span> <span class="pl-c1">2</span>},
    {return_query<span class="pl-k">:</span> <span class="pl-c1">true</span>}
);
<span class="pl-smi">queries</span>.<span class="pl-c1">push</span>(delete_query);

<span class="pl-smi">models</span>.<span class="pl-en">doBatch</span>(queries, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
});</pre></div>

<h2>
<a id="debug-logging-queries" class="anchor" href="#debug-logging-queries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Debug Logging Queries</h2>

<p>You can log the generated queries by the orm if you want. Just set the <code>DEBUG</code> environment variable like the following while starting your app:</p>

<pre><code>DEBUG=express-cassandra node app.js
</code></pre>

<h2>
<a id="raw-batch-query" class="anchor" href="#raw-batch-query" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Raw Batch Query</h2>

<p>You can get the batch query interface from cassandra nodejs-driver using the <code>execute_batch</code> method.</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-k">var</span> queries <span class="pl-k">=</span> [
    {
        query<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>...<span class="pl-pds">"</span></span>,
        params<span class="pl-k">:</span> [<span class="pl-k">...</span>]
    },
    {
        query<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>...<span class="pl-pds">"</span></span>,
        params<span class="pl-k">:</span> [<span class="pl-k">...</span>]
    }
];
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">execute_batch</span>(queries, <span class="pl-k">function</span>(<span class="pl-smi">err</span>){

});
</pre></div>

<h2>
<a id="get-the-client-driver-instance" class="anchor" href="#get-the-client-driver-instance" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Get the client driver instance</h2>

<p>You can get the client driver instance from cassandra nodejs-driver using the <code>get_cql_client</code> method. This will provide you a cql driver instance with which you can do anything you could possibly do with the datastax nodejs-driver version 3.0.</p>

<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-en">get_cql_client</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">client</span>){
    <span class="pl-smi">client</span>.<span class="pl-en">eachRow</span>(<span class="pl-s"><span class="pl-pds">'</span>Select * from person limit 10<span class="pl-pds">'</span></span>, [], { autoPage <span class="pl-k">:</span> <span class="pl-c1">true</span> }, <span class="pl-k">function</span>(<span class="pl-smi">n</span>, <span class="pl-smi">row</span>) {}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">result</span>){});
});
</pre></div>

<h2>
<a id="closing-connections-to-cassandra" class="anchor" href="#closing-connections-to-cassandra" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Closing connections to cassandra</h2>

<p>You can close all orm connections to cassandra by using the following function:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-c1">close</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>){
    <span class="pl-k">if</span>(err) <span class="pl-k">throw</span> err;
});</pre></div>

<h2>
<a id="note" class="anchor" href="#note" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Note</h2>

<p>All queries except schema definition related queries (i.e. create table etc.) are prepared by default. If you don't want to prepare queries, just set <code>prepare=false</code> in the options object.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">models</span>.<span class="pl-smi">instance</span>.<span class="pl-smi">Person</span>.<span class="pl-c1">find</span>(query, {prepare<span class="pl-k">:</span> <span class="pl-c1">false</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">people</span>){
    <span class="pl-c">//people is an array of plain objects</span>
});</pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/masumsoft/express-cassandra">Express Cassandra</a> is maintained by <a href="https://github.com/masumsoft">masumsoft</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
